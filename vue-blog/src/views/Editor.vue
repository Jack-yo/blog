<template>
  <div id="divDemo">
    <div class="toolbar" id="toolbar">
      <div class="menu" style="z-index:10001;" @mouseover="changeDisplay('header','block')" @mouseout="changeDisplay('header','none')">
        <i class="icon-header"></i>
        <div class="droplist" id="header" style="margin-top:30px; width:100px; display:none;" @mouseout="changeDisplay('header','none')" @mousedown="changeDisplay('header','none')">
          <p class="dp-title">è®¾ç½®æ ‡é¢˜</p>
          <ul class="list" id="header_list">
            <li class="item">
              <h1>H1</h1>
            </li>
            <li class="item">
              <h2>H2</h2>
            </li>
            <li class="item">
              <h3>H3</h3>
            </li>
            <li class="item">
              <h4>H4</h4></li>
            <li class="item">
              <h5>H5</h5>
            </li>
          </ul>
        </div>
      </div>

      <div class="menu" style="z-index:10001;" @mousedown=" execCommand('bold',false,null);">
        <i class="icon-bold"></i>
      </div>

      <div class="menu" style="z-index:10001;" @mouseover="changeDisplay('font-size','block')" @mouseout="changeDisplay('font-size','none')">
        <i class="icon-text-heigh"></i>
        <div class="droplist" id="font-size" style="margin-top:30px; width:160px; display:none;" @mouseout="changeDisplay('font-size','none')" @mousedown="changeDisplay('font-size','none')">
          <p class="dp-title">å­—å·</p>
          <ul class="list" id="font-size-list">
            <li class="item">
              <span style="font-size: x-small;">x-small</span>
            </li>
            <li class="item">
              <span style="font-size: small;">small</span>
            </li>
            <li class="item">
              <span>normal</span>
            </li>
            <li class="item">
              <span style="font-size: large;">large</span>
            </li>
            <li class="item">
              <span style="font-size: x-large;">x-large</span>
            </li>
            <li class="item">
              <span style="font-size: xx-large;">xx-large</span>
            </li>
          </ul>
        </div>
      </div>

      <div class="menu" style="z-index:10001;" @mouseover="changeDisplay('font','block')" @mouseout="changeDisplay('font','none')">
        <i class="icon-font"></i>
        <div class="droplist" id="font" style="margin-top:30px; width:100px; display:none;" @mouseout="changeDisplay('font','none')" @mousedown="changeDisplay('font','none')">
          <p class="dp-title">å­—ä½“</p>
          <ul class="list" id="font-list">
            <li class="item">
              <span style="font-family: å®‹ä½“;">å®‹ä½“</span>
            </li>
            <li class="item">
              <span style="font-family: æ¥·ä½“;">æ¥·ä½“</span>
            </li>
            <li class="item">
              <span style="font-family: é»‘ä½“;">é»‘ä½“</span>
            </li>
            <li class="item">
              <span style="font-family: å¾®è½¯é›…é»‘;">å¾®è½¯é›…é»‘</span>
            </li>
            <li class="item">
              <span style="font-family: Arial;">Arial</span>
            </li>
            <li class="item">
              <span style="font-family: Tahoma;">Tahoma</span>
            </li>
            <li class="item">
              <span style="font-family: Verdana;">Verdana</span>
            </li>
            <li class="item">
              <span style="font-family: Helvetica;">Helvetica</span>
            </li>
            <li class="item">
              <span style="font-family: Times;">Times</span>
            </li>
            <li class="item">
              <span style="font-family: Georgia;">Georgia</span>
            </li>
          </ul>
        </div>
      </div>

      <div class="menu" style="z-index:10001;" @mousedown=" execCommand('italic',false,null)">
        <i class="icon-italic"></i>
      </div>

      <div class="menu" style="z-index:10001;" @mousedown=" execCommand('underline',false,null)">
        <i class="icon-underline"></i>
      </div>

      <div class="menu" style="z-index:10001;" @mousedown=" execCommand('strikeThrough',false,null)">
        <i class="icon-strikethrough"></i>
      </div>

      <div class="menu" style="z-index:10001;" @mouseover="changeDisplay('font-color','block')" @mouseout="changeDisplay('font-color','none')">
        <i class="icon-pencil2"></i>
        <div class="droplist" id="font-color" style="margin-top:30px; width:120px; display:none;" @mouseout="changeDisplay('font-color','none')" @mousedown="changeDisplay('font-color','none')">
          <p class="dp-title">æ–‡å­—é¢œè‰²</p>
          <ul class="block" id="font-color-list">
            <li class="item">
              <div style="background-color:#000000;" contenteditable="false"></div>
            </li>
            <li class="item">
              <div style="background-color:#eeece0;" contenteditable="false"></div>
            </li>
            <li class="item">
              <div style="background-color:#1c487f;" contenteditable="false"></div>
            </li>
            <li class="item">
              <div style="background-color:#4d80bf;" contenteditable="false"></div>
            </li>
            <li class="item">
              <div style="background-color:#c24f4a;" contenteditable="false"></div>
            </li>
            <li class="item">
              <div style="background-color:#8baa4a;" contenteditable="false"></div>
            </li>
            <li class="item">
              <div style="background-color:#7b5ba1;" contenteditable="false"></div>
            </li>
            <li class="item">
              <div style="background-color:#46acc8;" contenteditable="false"></div>
            </li>
            <li class="item">
              <div style="background-color:#f9963b;" contenteditable="false"></div>
            </li>
            <li class="item">
              <div style="background-color:#ffffff; " contenteditable="false"></div>
            </li>
          </ul>
        </div>
      </div>

      <div class="menu" style="z-index:10001;" @mouseover="changeDisplay('bgcolor','block')" @mouseout="changeDisplay('bgcolor','none')">
        <i class="icon-paint-brush"></i>
        <div class="droplist" id="bgcolor" style="margin-top:30px; width:120px; display:none;" @mouseout="changeDisplay('bgcolor','none')" @mousedown="changeDisplay('bgcolor','none')">
          <p class="dp-title">èƒŒæ™¯è‰²</p>
          <ul class="block" id="bg-color-list">
            <li class="item">
              <div style="background-color:#000000;" contenteditable="false"></div>
            </li>
            <li class="item">
              <div style="background-color:#eeece0;" contenteditable="false"></div>
            </li>
            <li class="item">
              <div style="background-color:#1c487f;" contenteditable="false"></div>
            </li>
            <li class="item">
              <div style="background-color:#4d80bf;" contenteditable="false"></div>
            </li>
            <li class="item">
              <div style="background-color:#c24f4a;" contenteditable="false"></div>
            </li>
            <li class="item">
              <div style="background-color:#8baa4a;" contenteditable="false"></div>
            </li>
            <li class="item">
              <div style="background-color:#7b5ba1;" contenteditable="false"></div>
            </li>
            <li class="item">
              <div style="background-color:#46acc8;" contenteditable="false"></div>
            </li>
            <li class="item">
              <div style="background-color:#f9963b;" contenteditable="false"></div>
            </li>
            <li class="item">
              <div style="background-color:#ffffff;" contenteditable="false"></div>
            </li>
          </ul>
        </div>
      </div>

      <div class="menu" style="z-index:10001; margin:0 50px;">
        |
      </div>

      <div class="menu" style="z-index:10001;" @mousedown="changeDisplay('link','block')">
        <i class="icon-link"></i>
      </div>

      <div class="menu" style="z-index:10001;" @mouseover="changeDisplay('sequence','block')" @mouseout="changeDisplay('sequence','none')">
        <i class="icon-list2"></i>
        <div class="droplist" id="sequence" style="margin-top:30px; width:120px; display:none;" @mouseout="changeDisplay('sequence','none')" @mousedown="changeDisplay('sequence','none')">
          <p class="dp-title">è®¾ç½®åˆ—è¡¨</p>
          <ul class="list">
            <li class="item">
              <span @mousedown=" execCommand('insertOrderedList',false,null)"><i class="icon-list-numbered"></i> æœ‰åºåˆ—è¡¨</span>
            </li>
            <li class="item">
              <span @mousedown="execCommand('insertUnorderedList',false,null)"><i class="icon-list2" ></i> æ— åºåˆ—è¡¨</span>
            </li>
          </ul>
        </div>
      </div>

      <div class="menu" style="z-index:10001;" @mouseover="changeDisplay('align','block')" @mouseout="changeDisplay('align','none')">
        <i class="icon-paragraph-left"></i>
        <div class="droplist" id="align" style="margin-top:30px; width:100px; display:none;" @mouseout="changeDisplay('align','none')" @mousedown="changeDisplay('align','none')">
          <p class="dp-title">å¯¹é½æ–¹å¼</p>
          <ul class="list">
            <li class="item" @mousedown=" execCommand('justifyLeft',false,null)">
              <span><i class="icon-paragraph-left"></i> é å·¦</span>
            </li>
            <li class="item" @mousedown=" execCommand('justifyCenter',false,null)">
              <span><i class="icon-paragraph-center"></i> å±…ä¸­</span>
            </li>
            <li class="item" @mousedown=" execCommand('justifyRight',false,null)">
              <span><i class="icon-paragraph-right"></i> é å³</span>
            </li>
          </ul>
        </div>
      </div>

      <div class="menu" style="z-index:10001;" @mousedown="noCursor().insertQuote()">
        <i class="icon-quotes-left"></i>
      </div>

      <div class="menu" style="z-index:10001;" @mouseover="changeDisplay('emoji','block')" @mouseout="changeDisplay('emoji','none')">
        <i class="icon-happy"></i>
      </div>

      <div class="menu" id="img" style="z-index:10001;" @mousedown="changeDisplay('image','block')">
        <i class="icon-image"></i>
      </div>

      <div class="menu" style="z-index:10001;" @mousedown="changeDisplay('table','block')">
        <i class="icon-table2"></i>
      </div>

      <div class="menu" style="z-index:10001;" @mousedown="needCursor().transCode()">
        <i class="icon-terminal"></i>
      </div>

      <div class="menu" style="z-index:10001; margin:0 50px;">
        |
      </div>

      <div class="menu" style="z-index:10001;" @mousedown=" execCommand('undo',false,null)">
        <i class="icon-undo"></i>
      </div>

      <div class="menu" style="z-index:10001;" @mousedown="execCommand('redo',false,null)">
        <i class="icon-redo"></i>
      </div>

      <div class="menu" style="z-index:10001;" @mousedown="saveHTML()">
        <i class="el-icon-collection"></i>
      </div>

      <el-button type="text" @click="open" style="padding: 0; margin: 1px 0 1px 12%;" >
        <el-button type="primary"  style="padding:  6px; ">å‘å¸ƒ<i class="el-icon-upload el-icon--right"></i></el-button>
      </el-button>

      <el-button type="danger" style="padding: 6px; margin:2px 0 2px 3%;"  icon="el-icon-close" circle @click="centerDialogVisible = true"></el-button>

      <el-dialog
        title="æç¤º"
        :visible.sync="centerDialogVisible"
        width="30%"
        center>
        <span style="display: block;text-align: center">æ˜¯å¦å°†æ–‡ç« å­˜å…¥è‰ç¨¿ç®±</span>
        <span slot="footer" class="dialog-footer">
    <el-button @click="exit()">ä¸å­˜å…¥</el-button>
    <el-button type="primary" @click="uploadEditing()">ç¡® å®š</el-button>
        </span>
      </el-dialog>

    </div>

    <div style="border:1px solid #ccc; border-top:none; height:calc(100% - 37px); padding-top:37px;" class="text-container">
      <div contenteditable="true" style="width:100%; height:100%;" class="text" id="text-elem" @click="needCursor().saveCursor()" @keyup="needCursor().saveCursor()">
        <p>æ¬¢è¿ä½¿ç”¨<b>å¯Œæ–‡æœ¬ç¼–è¾‘å™¨</b>ï¼Œè¯·è¾“å…¥å†…å®¹...</p>
      </div>

      <div class="panel-container" id="link" style="width:300px; left: 20%;" >
        <i class="icon-close panel-close" @mousedown="changeDisplay('link','none')"></i>
        <ul class="panel-tab-title">
          <li class="item active">é“¾æ¥</li>
        </ul>
        <div class="panel-tab-content">
          <div>
            <input id="input-link" type="text" class="block" value="http://" placeholder="http://..." @keyup="needCursor().inputLink()">
            <div class="button-container">
              <button id="btn-ok" class="right" @mousedown="needCursor().insertLink()">åˆ é™¤å·²ç»‘å®šçš„è¶…é“¾æ¥</button>
              <button id="btn-de" class="gray right" style="display:none" @mousedown="cleanLink()">åˆ é™¤é“¾æ¥</button>
            </div>
          </div>
        </div>
      </div>

      <div class="panel-container" id="emoji" style="width:200px; left:43%" @mouseover="changeDisplay('emoji','block')" @mouseout="changeDisplay('emoji','none')">
        <ul class="panel-tab-title">
          <li class="item active">emoji</li>
        </ul>

        <div class="emoticon-container" id="emoji_list" style="display:block;">
          <span class="item">ğŸ˜€</span>
          <span class="item">ğŸ˜ƒ</span>
          <span class="item">ğŸ˜„</span>
          <span class="item">ğŸ˜</span>
          <span class="item">ğŸ˜†</span>
          <span class="item">ğŸ˜…</span>
          <span class="item">ğŸ˜‚</span>
          <span class="item">ğŸ˜Š</span>
          <span class="item">ğŸ˜‡</span>
          <span class="item">ğŸ™‚</span>
          <span class="item">ğŸ™ƒ</span>
          <span class="item">ğŸ˜‰</span>
          <span class="item">ğŸ˜“</span>
          <span class="item">ğŸ˜ª</span>
          <span class="item">ğŸ˜´</span>
          <span class="item">ğŸ™„</span>
          <span class="item">ğŸ¤”</span>
          <span class="item">ğŸ˜¬</span>
          <span class="item">ğŸ¤</span>
          <span class="item">ğŸ˜˜</span>
        </div>
      </div>

      <div class="panel-container" id="image" style="width:300px; left:35%">
        <i class="icon-close panel-close" @mousedown="changeDisplay('image','none')"></i>
        <ul class="panel-tab-title">
          <li class="item active">ä¸Šä¼ å›¾ç‰‡</li>
          <li class="item">ç½‘ç»œå›¾ç‰‡</li>
        </ul>
        <div class="panel-tab-content">
          <div class="up-img-container">
            <div id="up-trigger" class="up-btn">
              <i class="icon-upload2" @mousedown="needCursor().insertImage()"></i>
            </div>
            <div style="display:none;">
              <input id="up-file" type="file" multiple="multiple" accept="image/jpg,image/jpeg,image/png,image/gif,image/bmp" @change="needCursor().uploadImage($event)">
            </div>
          </div>
          <div style="display:none;">
            <input id="link-url" type="text" class="block" placeholder="å›¾ç‰‡é“¾æ¥">
            <div class="button-container">
              <button id="link-btn" class="right">æ’å…¥</button>
            </div>
          </div>
        </div>
      </div>

      <div class="panel-container" id="table" style="width:250px; left:38%">
        <i class="icon-close panel-close" @mousedown="changeDisplay('table','none')"></i>
        <ul class="panel-tab-title">
          <li class="item active">æ’å…¥è¡¨æ ¼</li>
        </ul>
        <div class="panel-tab-content">
          <div>
            <p style="text-align:left; padding:5px 0;">
              åˆ›å»º
              <input id="row" type="text" value="5" style="width:40px;text-align:center;">
              è¡Œ
              <input id="col" type="text" value="5" style="width:40px;text-align:center;">
              åˆ—çš„è¡¨æ ¼
            </p>
            <div class="button-container">
              <button id="btn" class="right" @click="needCursor().insertTable()">æ’å…¥</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
  import noCursor from '../assets/js/editor/noCursor.js'
  import  handleClick  from '../assets/js/editor/handleImg.js'
  import needCursor from '../assets/js/editor/needCursor.js'
  export default {
    name: 'editor',
    data: ()=>{
      return {
        article:{
          username:'',
          token:'',
          title:'',
          savedHTML:'',
        },
        centerDialogVisible:false,//æ˜¯å¦å­˜å…¥è‰ç¨¿ç®±çš„å¯¹è¯æ¡†æ˜¾ç¤ºçŠ¶æ€
      }
    },
    mounted:()=>{
      document.getElementById('toolbar').onmousedown = function(e){
        //ç°ä»£æµè§ˆå™¨é˜»æ­¢é»˜è®¤äº‹ä»¶
        if ( e && e.preventDefault )
          e.preventDefault();
        //IEé˜»æ­¢é»˜è®¤äº‹ä»¶
        else
          window.event.returnValue = false;

        return false;
      };

      //ä¸ºä¸€äº›æ ·å¼é€‰æ‹©æ·»åŠ ç»‘å®šäº‹ä»¶
      noCursor.headerChoose();
      noCursor.fontSizeChoose();
      noCursor.fontNameChoose();
      noCursor.ColorChoose('font-color-list');
      noCursor.emojiChoose();
      noCursor.ColorChoose('bg-color-list');

      //å¼€å¯æ–‡æœ¬æ¡†è¾“å…¥ç›‘å¬ï¼Œæ£€æŸ¥æ˜¯å¦ç‚¹å‡»ç…§ç‰‡
      let editor = document.getElementById('text-elem');
      editor.addEventListener('click', handleClick.handleClick);
    },
    methods: {
      //æ”¹å˜æ ·å¼é€‰æ‹©çš„ä¸‹æ‹‰åˆ—è¡¨æ˜¾ç¤ºçŠ¶æ€
      changeDisplay(ID,state) {
          document.getElementById(ID).style.display = state;
      },
      //è·å–éœ€è¦å…‰æ ‡çš„æ–¹æ³•
      needCursor(){
        return needCursor;
      },
      //æ‰§è¡Œdocument.execCommand
      execCommand (commandId, showUI, value) {
        return  document.execCommand(commandId,showUI,value);
      },
      //è·å–ä¸éœ€è¦å…‰æ ‡çš„æ–¹æ³•
      noCursor(){
        return noCursor
      },
      //å¡«å†™æ–‡ç« æ ‡é¢˜
      open() {
        this.$prompt('è¯·è¾“å…¥æ–‡ç« æ ‡é¢˜', 'æç¤º', {
          confirmButtonText: 'ç¡®å®š',
          cancelButtonText: 'å–æ¶ˆ',
        }).then(({value}) => {
          this.article.title = value;
          this.upload();
        })
      },
      //å°†å·²ç¼–è¾‘å†…å®¹å­˜åœ¨dataä¸­
      saveHTML(){
        this.article.savedHTML = document.getElementById('text-elem').innerHTML;
        this.$store.state.savedHTML = this.article.savedHTML;
      },
      //ä¸Šä¼ å·²ç¼–è¾‘å†…å®¹
      upload(){
        this.saveHTML();
        this.$axios.post('/publicArticle',{
           name:'root',//this.article.username
          token:'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuYW1lIjoicm9vdCIsImlhdCI6MTU5MDMzMjQ0MX0.W5rSk8OqmU-guUw4nV6Zgnwl2m7NW0pFJpj2jSqhaNo',// this.article.token
          title:this.article.title,
          pubarticle:this.article.savedHTML
        }).then( res => {
           if(res.data.code === 200){
             this.$message.success('å‘å¸ƒæˆåŠŸ');
             this.$router.push({path:'/home'});
           }else {
             this.$message.error('å‘å¸ƒå¤±è´¥ï¼Œè¯·é‡è¯•');
           }
        });
        console.log(this.article.savedHTML);
      },
      //æç¤ºç”¨æˆ·æ˜¯å¦ä¸¢å¼ƒ
      exit() {
        this.$message.warning('æ–‡ç« å·²ä¸¢å¼ƒ');
        this.centerDialogVisible = false;
        this.$router.push({path:'/home'});
      },
      //ä¸Šä¼ æ–‡ç« åˆ°è‰ç¨¿ç®±
      uploadEditing(){
        this.saveHTML();
        this.$axios.post('/editingArticle',{
          name:'root',//this.article.username
          token:'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuYW1lIjoicm9vdCIsImlhdCI6MTU5MDMzMjQ0MX0.W5rSk8OqmU-guUw4nV6Zgnwl2m7NW0pFJpj2jSqhaNo',// this.article.token
          title:this.article.title,
          editingarticle:this.article.savedHTML
        }).then( res => {
          this.centerDialogVisible = false;
          if(res.data.code === 200){
            this.$message.success('ä¿å­˜è‰ç¨¿ç®±æˆåŠŸ');
            this.$router.push({path:'/home'});
          }else {
            this.$message.error('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
          }
        });
        console.log(this.article.savedHTML);
      }
    },
  }
</script>

<style src="@/assets/css/editor.css"></style>

